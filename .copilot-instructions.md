# PHP CoreLib - Copilot Instructions

## Library Overview

**php-corelib** is a lightweight, fast PHP framework for building MVC applications. Influenced by Phalcon and CodeIgniter, it provides a minimal but complete toolkit for web development including routing, database abstraction, HTTP request handling, and CLI support.

- **Namespace**: `CoreLib`
- **PHP Version**: >= 8.0
- **License**: MIT
- **Dependencies**: PSR/Log >= 3.0

## Core Components

### 1. MVC Layer (`CoreLib\Mvc`)

#### Router (`Router.php`)

- **Purpose**: Handles URL routing and dispatches requests to controllers
- **Key Features**:
  - Route pattern matching with placeholders (`:namespace`, `:controller`, `:action`, `:params`, `:int`)
  - Custom placeholder support via `addPlaceHolder()`
  - Configurable default controller and action
  - Parameter parsing
- **Common Patterns**:
  ```php
  $router = new Router();
  $router->add('pattern', 'controller/action');
  $router->dispatch($_GET['_route']);
  ```

#### Controller (`Controller.php`)

- **Purpose**: Base class for MVC controllers
- **Features**:
  - Automatic `HttpRequest` injection
  - View integration
  - Redirect method for HTTP redirects
- **Usage**: All controllers should extend `Controller`
- **Protected Properties**:
  - `$request`: HttpRequest instance
  - `$view`: View instance

#### Model (`Model.php`)

- **Purpose**: Abstract base class for ORM models with database builder integration
- **Key Methods**:
  - `selectBuilder()`: Returns a SelectBuilder for querying
  - `insertBuilder()`: Returns an InsertBuilder for inserting records
  - `updateBuilder()`: Returns an UpdateBuilder for updating records
  - `deleteBuilder()`: Returns a DeleteBuilder for deleting records
- **Database Integration**: Models use reflection to auto-detect table names and columns

#### View (`View.php`)

- **Purpose**: Template rendering engine
- **Integration**: Controllers use this for rendering responses

### 2. Database Layer (`CoreLib\Db`)

#### Query Builders

All builders support method chaining and prepared statements for SQL injection protection.

##### SelectBuilder (`SelectBuilder.php`)

- **Purpose**: Build and execute SELECT queries
- **Key Methods**:
  - `from(string|Model $table, string $alias = null)`: Set FROM clause
  - `columns(array $columns)`: Select specific columns
  - `where($column, $value, $operator = '=')`: Add WHERE conditions
  - `join()`, `leftJoin()`, `rightJoin()`: Join tables
  - `groupBy()`, `orderBy()`: Group and sort results
  - `limit(int $limit)`, `offset(int $offset)`: Pagination
  - `distinct()`: Remove duplicates
  - `execute()`: Run query and return ResultSet
- **Example**:
  ```php
  (new SelectBuilder())
      ->from('Race')
      ->columns(['status', 'start_time'])
      ->where('id', 123)
      ->execute()
  ```

##### InsertBuilder (`InsertBuilder.php`)

- **Purpose**: Build and execute INSERT queries
- **Key Methods**:
  - `insert(string|Model $table)`: Set table
  - `columns(array $columns)`: Define columns
  - `values(array $values)`: Set values for one row
  - `batchInsert(array $rows)`: Insert multiple rows
  - `execute()`: Execute insert

##### UpdateBuilder (`UpdateBuilder.php`)

- **Purpose**: Build and execute UPDATE queries
- **Key Methods**:
  - `update(string|Model $table)`: Set table
  - `set(array $data)`: Set column values
  - `where()`: Add conditions
  - `execute()`: Execute update

##### DeleteBuilder (`DeleteBuilder.php`)

- **Purpose**: Build and execute DELETE queries
- **Key Methods**:
  - `delete(string|Model $table)`: Set table
  - `where()`: Add conditions
  - `execute()`: Execute delete

#### BaseBuilder & BaseConditionBuilder

- **Purpose**: Abstract base classes providing common functionality
- **Features**:
  - Condition building (`where()`, `andWhere()`, `orWhere()`)
  - Parameter binding for prepared statements
  - SQL compilation
  - Transaction support

#### PdoDriver (`PdoDriver.php`)

- **Purpose**: PDO wrapper for database connections
- **Features**:
  - Connection pooling
  - Transaction management
  - Query execution with prepared statements

#### ResultSet (`ResultSet.php`)

- **Purpose**: Iterator for SELECT query results
- **Features**:
  - Lazy loading of results
  - Model object instantiation
  - Pagination support

#### ModelCache (`ModelCache.php`)

- **Purpose**: Cache model definitions for performance
- **Usage**: Set via `BaseBuilder::setModelCache()`

### 3. HTTP Layer (`CoreLib\Http`)

#### Request (`Request.php`)

- **Purpose**: Wrapper for handling HTTP requests
- **Key Methods**:
  - `get(string $name, $default = null)`: Get REQUEST variable
  - `getPost(string $name, $default = null)`: Get POST variable
  - `getQuery(string $name, $default = null)`: Get GET variable
  - `getHeader(string $name)`: Get HTTP header
  - `parseJsonPostData()`: Parse JSON request body
  - `extractJsonPostData()`: Extract JSON into $\_POST
  - `isXmlHttpRequest()`: Check if AJAX request
  - `isPost()`, `isGet()`: Check request method
  - `getCookie(string $name)`: Get cookie value

#### Cookie (`Cookie.php`)

- **Purpose**: Manage HTTP cookies
- **Typical Uses**: Session/authentication cookie handling

### 4. CLI Layer (`CoreLib\Cli`)

#### Console (`Console.php`)

- **Purpose**: CLI output formatting and interaction
- **Features**: Colored output, progress bars, user input

#### Task (`Task.php`)

- **Purpose**: Base class for CLI commands
- **Usage**: Extend for custom CLI tasks

### 5. Logging (`CoreLib\Monolog`)

#### RollingFileHandler (`Handler/RollingFileHandler.php`)

- **Purpose**: Monolog handler for rotating log files
- **Integration**: Works with PSR/Log

#### TokenProcessor (`Processor/TokenProcessor.php`)

- **Purpose**: Log processor for adding context tokens

### 6. Exception Handling (`CoreLib\Exception`)

#### Exception (`Exception.php`)

- **Purpose**: Base exception class for the framework
- **Specialized Exceptions**:
  - `Db\Exception`: Database-related errors
  - `Db\TransactionLostException`: Transaction state loss

## Code Style & Conventions

### PHP Standards

- **PHP 8.0+** features supported (typed properties, named arguments, etc.)
- **PSR-4** autoloading with `CoreLib\` namespace
- **Prepared statements** for all database queries (no SQL concatenation)
- **Method chaining** where applicable for fluent APIs

### Naming Conventions

- **Classes**: PascalCase (e.g., `SelectBuilder`, `HttpRequest`)
- **Methods**: camelCase (e.g., `executeQuery()`, `setLimit()`)
- **Private/Protected Properties**: prefixed with `_` (e.g., `$_bindParams`, `$_routes`)
- **Constants**: UPPER_SNAKE_CASE

### Documentation

- DocBlocks for public methods and properties
- Type hints for parameters and return types
- Examples in DocBlocks where useful

## Common Development Tasks

### Building a SELECT Query

```php
use CoreLib\Db\SelectBuilder;

$result = (new SelectBuilder())
    ->from('users')
    ->columns(['id', 'name', 'email'])
    ->where('status', 'active')
    ->orderBy('created_at', 'DESC')
    ->limit(10)
    ->execute();
```

### Building a Model

```php
namespace MyApp;
use CoreLib\Mvc\Model;

class User extends Model
{
    // Table name auto-detected: 'User'
    public int $id;
    public string $name;
    public string $email;
}

// Query via model
$users = User::selectBuilder()
    ->where('status', 'active')
    ->execute();
```

### Creating a Controller

```php
namespace MyApp;
use CoreLib\Mvc\Controller;

class UserController extends Controller
{
    public function viewAction($id = null)
    {
        $user = User::selectBuilder()
            ->where('id', $id)
            ->execute()
            ->fetch();

        $this->view->setVar('user', $user);
    }
}
```

### Handling HTTP Requests

```php
$request = new CoreLib\Http\Request();

if ($request->isPost()) {
    $name = $request->getPost('name');
    $email = $request->getPost('email');
}

if ($request->isXmlHttpRequest()) {
    // Handle AJAX
    $data = $request->parseJsonPostData();
}
```

## Architecture Principles

1. **Minimal Dependencies**: Only PSR/Log for logging
2. **Performance First**: Lightweight, caching support
3. **Fluent API**: Builders use method chaining
4. **Type Safety**: Strong typing with PHP 8.0+
5. **Database Agnostic**: PDO-based for any database
6. **MVC Separation**: Clear separation of concerns

## When Assisting with This Codebase

### Do:

- Suggest fluent API method chaining for builders
- Recommend prepared statements for all database operations
- Use `SelectBuilder`, `InsertBuilder`, etc. for queries
- Apply proper type hints with PHP 8.0+ syntax
- Leverage Model classes for ORM functionality
- Check for SQL injection vulnerabilities
- Maintain PSR-4 autoloading structure

### Don't:

- Use raw SQL string concatenation
- Bypass the builder pattern for database operations
- Create controllers not extending `Controller`
- Mix presentation logic with business logic
- Ignore type hints on public APIs
- Use globals directly; use Request class instead

## Testing Recommendations

- Use `BaseBuilder::$UseModels` flag to control model instantiation
- Create fixtures using the `InsertBuilder`
- Test builders with different database drivers
- Mock `PdoDriver` for unit tests

## Performance Optimization

- Use `ModelCache` for frequently accessed model definitions
- Leverage `SelectBuilderPaginator` for large result sets
- Use database indexes on frequently queried columns
- Consider `limit()` and `offset()` for pagination
- Use `columns()` to select only needed fields

## References

- **Influenced by**: Phalcon, CodeIgniter
- **License**: MIT
- **Repository**: osiramen/php-corelib
