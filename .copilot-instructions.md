# Merlin Framework - Copilot Instructions

## Scope

These instructions apply to all code and docs in this repository.

## Project Facts

- Package: `simsaai/merlin`
- Namespace: `Merlin\`
- Runtime: PHP `>=8.0`
- Style: PSR-12
- Test runner: `./vendor/bin/phpunit`

## Source of Truth

When docs or examples conflict with implementation, trust in this order:

1. `tests/`
2. `src/`
3. `README.md` / `docs/`
4. `examples/`

Prefer changing docs/examples to match code unless a requested feature requires changing code.

## Architecture Overview

- `Merlin\AppContext` is the runtime service container (DB, request, view, session, cookies).
- MVC dispatch flow is:
  - `Router::add(...)`
  - `Router::match($uri, $method)`
  - `Dispatcher::dispatch($routeInfo)`
- ORM is `Merlin\Mvc\Model` + unified `Merlin\Db\Query`.
- CLI dispatch is `Merlin\Cli\Console::handle($task, $action, $params)` with `Task` subclasses.

## API Conventions (Important)

### Router

- `Router::add(string|array|null $method, string $pattern, string|array|null $handler = null)`
- Patterns use `{name}` and optional type like `{id:int}`.
- Dynamic tokens are `{:namespace}`, `{:controller}`, `{:action}`, `{:params}`.
- There is no `Router::handle()` method in current API.
- Use `setBaseNamespace(...)`, not `setNamespace(...)`.

### Dispatcher

- `Dispatcher::dispatch(array $routeInfo): Merlin\Http\Response`
- Controller actions can return `Response`, `array`, `string`, `int`, `null`, or `JsonSerializable`.

### Model

- Use `Model::query()` for builder access.
- Load helpers are:
  - `find($id)`
  - `findOne(array $conditions)`
  - `findAll(array $conditions = [])`
- Persistence methods:
  - `save()`, `insert()`, `update()`, `delete()`
- Connection overrides are supported via `setDefaultReadConnection()` / `setDefaultWriteConnection()` and `readConnection()` / `writeConnection()`.

### Query

- Unified builder class: `Merlin\Db\Query`
- Common terminal methods:
  - `select()`
  - `first()`
  - `insert()` / `upsert()`
  - `update()`
  - `delete()`
  - `exists()`
  - `count()`
- There is no required final `execute()` call for these terminal methods.

### CLI

- Use `Console::setNamespace('App\\Tasks')`.
- `Console::handle($task, $action, $params)` receives parsed arguments from entry script.

## Documentation Rules

When editing docs/examples:

- Keep examples executable and consistent with `src/`.
- Prefer concise examples that demonstrate one concept clearly.
- For DB examples, wire `Database` into `AppContext::instance()->db` (and `dbRead`/`dbWrite` where relevant).
- Use only current API names: `Merlin`, `Query`, `Router::match()`, `Dispatcher::dispatch()`, model methods like `find()`, `findOne()`, `findAll()`.

## Change Guidelines

- Keep changes focused and minimal.
- Do not rename public APIs unless explicitly requested.
- Do not add dependencies unless needed.
- Preserve backward-compatible behavior where possible.

## Validation Checklist

After making changes:

1. Run `./vendor/bin/phpunit`.
2. Ensure edited docs do not reference missing methods.
3. Ensure examples compile against current classes/method names.
